<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Whisper Local UI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .drop-zone-active {
            border-color: #2563eb;
            background-color: #1e3a8a;
        }
        #transcript-output {
            white-space: pre-wrap; /* Preserve whitespace and newlines */
            word-wrap: break-word;
        }
        .progress-bar-inner {
            transition: width 0.5s ease-in-out;
        }
        .download-btn {
            background-color: #374151;
            color: #e5e7eb;
            font-weight: 500;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            transition: background-color 0.2s;
        }
        .download-btn:hover:not(:disabled) {
            background-color: #4b5563;
        }
        .download-btn:disabled {
            background-color: #1f2937;
            color: #6b7280;
            cursor: not-allowed;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-200 flex items-center justify-center min-h-screen py-8">

    <div class="w-full max-w-4xl mx-auto p-4 md:p-8">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold text-white">Whisper Local UI</h1>
            <p class="text-gray-400 mt-2">A simple interface for OpenAI's Whisper running on your machine.</p>
        </header>

        <main class="bg-gray-800 shadow-2xl rounded-2xl p-6 md:p-8">
            <!-- Step 1: Configuration -->
            <div class="mb-6">
                <h2 class="text-xl font-semibold text-white mb-4 border-b border-gray-700 pb-2">1. Configuration</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label for="model" class="block text-sm font-medium text-gray-300 mb-1">Model</label>
                        <select id="model" class="w-full bg-gray-700 border-gray-600 text-white rounded-lg p-2.5 focus:ring-blue-500 focus:border-blue-500">
                            <option>tiny</option>
                            <option>base</option>
                            <option selected>small</option>
                            <option>medium</option>
                            <option>large</option>
                        </select>
                    </div>
                    <div>
                        <label for="language" class="block text-sm font-medium text-gray-300 mb-1">Language</label>
                        <select id="language" class="w-full bg-gray-700 border-gray-600 text-white rounded-lg p-2.5 focus:ring-blue-500 focus:border-blue-500">
                            <!-- Languages will be populated by JavaScript -->
                        </select>
                    </div>
                    <div>
                        <label for="task" class="block text-sm font-medium text-gray-300 mb-1">Task</label>
                        <select id="task" class="w-full bg-gray-700 border-gray-600 text-white rounded-lg p-2.5 focus:ring-blue-500 focus:border-blue-500">
                            <option value="transcribe" selected>Transcribe</option>
                            <option value="translate">Translate to English</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Step 2: Upload File -->
            <div class="mb-6">
                <h2 class="text-xl font-semibold text-white mb-4 border-b border-gray-700 pb-2">2. Upload Audio/Video File</h2>
                <div id="drop-zone" class="border-2 border-dashed border-gray-600 rounded-lg p-8 text-center cursor-pointer hover:border-blue-500 transition-colors">
                    <input type="file" id="file-input" class="hidden" />
                    <p id="drop-zone-text" class="text-gray-400">Drag & drop your file here, or click to select a file</p>
                    <p id="file-name" class="text-blue-400 font-medium mt-2"></p>
                </div>
            </div>

            <!-- Step 3: Process & View Output -->
            <div>
                <h2 class="text-xl font-semibold text-white mb-4 border-b border-gray-700 pb-2">3. Output</h2>
                <div class="bg-gray-900 rounded-lg p-4 min-h-[200px] relative">
                    <div id="status-container" class="absolute inset-0 flex flex-col items-center justify-center bg-gray-900 bg-opacity-90 rounded-lg hidden z-10">
                        <p id="status-text" class="font-medium text-lg mb-4">Processing...</p>
                        <div class="w-3/4 bg-gray-700 rounded-full h-2.5">
                            <div id="progress-bar" class="bg-blue-600 h-2.5 rounded-full progress-bar-inner" style="width: 0%"></div>
                        </div>
                    </div>
                    <button id="copy-button" class="absolute top-2 right-2 bg-blue-600 hover:bg-blue-700 text-white font-bold py-1 px-3 rounded-lg text-sm transition-colors hidden z-20">Copy</button>
                    <pre id="transcript-output" class="text-gray-300">Your transcript will appear here.</pre>
                </div>
                
                <!-- Download Buttons -->
                <div id="download-container" class="mt-4 hidden">
                     <h3 class="text-lg font-semibold text-white mb-2 text-center">Download Formats</h3>
                     <div class="flex justify-center items-center gap-4">
                         <button id="download-txt" class="download-btn" disabled>.txt</button>
                         <button id="download-vtt" class="download-btn" disabled>.vtt</button>
                         <button id="download-srt" class="download-btn" disabled>.srt</button>
                     </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // --- All Supported Languages for Whisper ---
        const WHISPER_LANGUAGES = {
            "Afrikaans": "af", "Albanian": "sq", "Amharic": "am", "Arabic": "ar", "Armenian": "hy", "Assamese": "as", "Azerbaijani": "az", "Bashkir": "ba", "Basque": "eu", "Belarusian": "be", "Bengali": "bn", "Bosnian": "bs", "Breton": "br", "Bulgarian": "bg", "Burmese": "my", "Cantonese": "yue", "Catalan": "ca", "Chinese": "zh", "Croatian": "hr", "Czech": "cs", "Danish": "da", "Dutch": "nl", "English": "en", "Estonian": "et", "Faroese": "fo", "Finnish": "fi", "French": "fr", "Galician": "gl", "Georgian": "ka", "German": "de", "Greek": "el", "Gujarati": "gu", "Haitian Creole": "ht", "Hausa": "ha", "Hawaiian": "haw", "Hebrew": "he", "Hindi": "hi", "Hungarian": "hu", "Icelandic": "is", "Indonesian": "id", "Italian": "it", "Japanese": "ja", "Javanese": "jw", "Kannada": "kn", "Kazakh": "kk", "Khmer": "km", "Korean": "ko", "Lao": "lo", "Latin": "la", "Latvian": "lv", "Lingala": "ln", "Lithuanian": "lt", "Luxembourgish": "lb", "Macedonian": "mk", "Malagasy": "mg", "Malay": "ms", "Malayalam": "ml", "Maltese": "mt", "Maori": "mi", "Marathi": "mr", "Mongolian": "mn", "Nepali": "ne", "Norwegian": "no", "Nynorsk": "nn", "Occitan": "oc", "Pashto": "ps", "Persian": "fa", "Polish": "pl", "Portuguese": "pt", "Punjabi": "pa", "Romanian": "ro", "Russian": "ru", "Sanskrit": "sa", "Serbian": "sr", "Shona": "sn", "Sindhi": "sd", "Sinhala": "si", "Slovak": "sk", "Slovenian": "sl", "Somali": "so", "Spanish": "es", "Sundanese": "su", "Swahili": "sw", "Swedish": "sv", "Tagalog": "tl", "Tajik": "tg", "Tamil": "ta", "Tatar": "tt", "Telugu": "te", "Thai": "th", "Tibetan": "bo", "Turkish": "tr", "Turkmen": "tk", "Ukrainian": "uk", "Urdu": "ur", "Uzbek": "uz", "Vietnamese": "vi", "Welsh": "cy", "Yiddish": "yi", "Yoruba": "yo"
        };

        // --- DOM Element References ---
        const dropZone = document.getElementById('drop-zone');
        const fileInput = document.getElementById('file-input');
        const fileNameDisplay = document.getElementById('file-name');
        const languageSelect = document.getElementById('language');
        const statusContainer = document.getElementById('status-container');
        const statusText = document.getElementById('status-text');
        const transcriptOutput = document.getElementById('transcript-output');
        const copyButton = document.getElementById('copy-button');
        const progressBar = document.getElementById('progress-bar');
        const downloadContainer = document.getElementById('download-container');
        const downloadTxtBtn = document.getElementById('download-txt');
        const downloadVttBtn = document.getElementById('download-vtt');
        const downloadSrtBtn = document.getElementById('download-srt');

        let selectedFile = null;
        let progressInterval = null;
        let transcriptData = {};
        
        // --- Initialization ---
        function populateLanguages() {
            languageSelect.innerHTML = ''; // Clear existing options
            const autoOption = document.createElement('option');
            autoOption.value = 'auto';
            autoOption.textContent = 'Auto-Detect';
            autoOption.selected = true;
            languageSelect.appendChild(autoOption);
            const sortedLanguageNames = Object.keys(WHISPER_LANGUAGES).sort();
            for (const langName of sortedLanguageNames) {
                const option = document.createElement('option');
                option.value = WHISPER_LANGUAGES[langName];
                option.textContent = langName;
                languageSelect.appendChild(option);
            }
        }
        populateLanguages();

        // --- Event Listeners ---
        dropZone.addEventListener('click', () => fileInput.click());
        fileInput.addEventListener('change', (e) => handleFileSelection(e.target.files));
        dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('drop-zone-active'); });
        dropZone.addEventListener('dragleave', (e) => { e.preventDefault(); dropZone.classList.remove('drop-zone-active'); });
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('drop-zone-active');
            handleFileSelection(e.dataTransfer.files);
        });
        copyButton.addEventListener('click', () => {
            // Use the newer Clipboard API if available, with a fallback
            if (navigator.clipboard) {
                 navigator.clipboard.writeText(transcriptOutput.textContent).then(() => {
                    copyButton.textContent = 'Copied!';
                    setTimeout(() => { copyButton.textContent = 'Copy'; }, 2000);
                });
            } else {
                // Fallback for older browsers
                const tempTextArea = document.createElement('textarea');
                tempTextArea.value = transcriptOutput.textContent;
                document.body.appendChild(tempTextArea);
                tempTextArea.select();
                document.execCommand('copy');
                document.body.removeChild(tempTextArea);
                copyButton.textContent = 'Copied!';
                setTimeout(() => { copyButton.textContent = 'Copy'; }, 2000);
            }
        });

        downloadTxtBtn.addEventListener('click', () => downloadFile(transcriptData.txt, `${getFilenameBase()}.txt`, 'text/plain'));
        downloadVttBtn.addEventListener('click', () => downloadFile(transcriptData.vtt, `${getFilenameBase()}.vtt`, 'text/vtt'));
        downloadSrtBtn.addEventListener('click', () => downloadFile(transcriptData.srt, `${getFilenameBase()}.srt`, 'application/x-subrip'));

        // --- Core Functions ---
        function getFilenameBase() {
            if (!selectedFile) return 'transcript';
            return selectedFile.name.substring(0, selectedFile.name.lastIndexOf('.')) || selectedFile.name;
        }

        function downloadFile(content, fileName, mimeType) {
            if (!content) return;
            const blob = new Blob([content], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = fileName;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function handleFileSelection(files) {
            if (files.length > 0) {
                selectedFile = files[0];
                document.getElementById('drop-zone-text').classList.add('hidden');
                fileNameDisplay.textContent = `Selected file: ${selectedFile.name}`;
                transcribeFile();
            }
        }

        function startProgressSimulation() {
            if (progressInterval) clearInterval(progressInterval);
            progressBar.style.width = '0%';
            statusContainer.classList.remove('hidden');
            statusText.textContent = 'Processing...';
            let width = 0;
            progressInterval = setInterval(() => {
                width += (width < 80) ? Math.random() * 5 : Math.random() * 1;
                if (width >= 99) width = 99;
                progressBar.style.width = width + '%';
            }, 500);
        }

        function stopProgressSimulation(isSuccess = true) {
            if(progressInterval) clearInterval(progressInterval);
            progressInterval = null;
            if (isSuccess) {
                progressBar.style.width = '100%';
                statusText.textContent = 'Complete!';
                setTimeout(() => statusContainer.classList.add('hidden'), 1000);
            } else {
                statusContainer.classList.add('hidden');
            }
        }

        function updateDownloadButtons() {
            downloadContainer.classList.remove('hidden');
            downloadTxtBtn.disabled = !transcriptData.txt;
            downloadVttBtn.disabled = !transcriptData.vtt;
            downloadSrtBtn.disabled = !transcriptData.srt;
        }

        async function transcribeFile() {
            if (!selectedFile) return;
            startProgressSimulation();
            transcriptOutput.textContent = 'Your transcript will appear here.';
            copyButton.classList.add('hidden');
            downloadContainer.classList.add('hidden');
            transcriptData = {};

            const formData = new FormData();
            formData.append('file', selectedFile);
            formData.append('model', document.getElementById('model').value);
            formData.append('language', languageSelect.value);
            formData.append('task', document.getElementById('task').value);

            try {
                const response = await fetch('http://127.0.0.1:5000/transcribe', { method: 'POST', body: formData });
                const result = await response.json();
                
                stopProgressSimulation(response.ok);

                if (!response.ok) throw new Error(result.error || 'An unknown error occurred.');
                
                transcriptData = result;
                transcriptOutput.textContent = transcriptData.txt ? transcriptData.txt.trim() : 'No text transcript was generated.';
                
                if (transcriptData.txt) {
                    copyButton.classList.remove('hidden');
                }
                
                updateDownloadButtons();

            } catch (error) {
                console.error('Error:', error);
                stopProgressSimulation(false);
                transcriptOutput.textContent = `Error: ${error.message}\n\nIs the local Python server running? See setup instructions.`;
            }
        }
    </script>
</body>
</html>
